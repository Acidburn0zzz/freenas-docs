#!/usr/bin/env perl

use strict;
use warnings;

use File::Basename;
use Getopt::Std;
use Scalar::Util qw(looks_like_number);

our ($opt_h, $opt_t, $opt_r);

our $prolog = <<PROLOG;
  <!-- googlize start -->
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-2174408-18"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-2174408-18');
  </script>
  <script type="text/javascript" src="/documentation/js/jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="/documentation/js/lodash-4.17.11.min.js"></script>
  <script type="text/javascript" src="/documentation/js/jquery.selectric-1.13.0.min.js"></script>
  <link rel="stylesheet" href="/documentation/css/jquery.selectric-1.13.0.css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,400i,700&amp;subset=latin-ext" rel="stylesheet">
  <!-- googlize end -->
PROLOG

our $epilog = <<EPILOG;
  <!-- googlize button start -->
  <div id="float-box">
    <div id="float-header">
      <span id="current-version">loading...</span>
      <span id="float-toggle"></span>
    </div>
    <div id="expanded-float">
      <span class="float-title">Other versions:</span>
      <select id="version" name="version">
      </select>

      <div id="notstable">
      </div>

      <span class="float-title">Documentation:</span>
      <div id="format">
      </div>

      <span class="float-title">Other:</span>
      <div id="link">
      </div>
    </div>
  </div>

  <script>
  var releases;
  var url = window.location.href;
  var regex = /\\/(true|free.*)\\/(\\d.*)\\//i;
  var urlMatch = regex.exec(url);
  var curSystem = urlMatch[1];
  var curSlug = urlMatch[2];
  var curObject;


  function populateVersionSelect(versions) {
    var verOptions = [];
    _.forEach(versions, function(version) {
      if (version.slug === curSlug) {
        verOptions.push("<option data-status='" + version.status + "' value='" + version.slug + "' selected>" + version.name + "</option>");
      } else {
        verOptions.push("<option data-status='" + version.status + "' value='" + version.slug + "'>" + version.name + "</option>");
      }
    });
    jQuery("#version").html(verOptions.join("")).selectric('refresh');
  }

  function populateFormatFlex(selectedSlug) {
    var frmtOptions = [];
    selectedVersion = _.find(releases[curSystem], { 'slug': selectedSlug });
    _.forEach(selectedVersion.types, function(type) {
      frmtOptions.push("<div><a title='"+ type.title +"' class='doc-link' href='" + "/documentation/" + curSystem + "/" + selectedSlug + "/" + type.index +"."+ type.format + "'>" + type.format + "</a></div>");
    });
    while (frmtOptions.length < 5) {
      frmtOptions.push("<div></div>");
    }
    jQuery("#format").html(frmtOptions.join(""));
  }

  function populateLinkFlex(selectedSlug) {
    var linkOptions = [];
    selectedVersion = _.find(releases[curSystem], { 'slug': selectedSlug });
    _.forEach(selectedVersion.links, function(link) {
      linkOptions.push("<div><a title='"+ link.title +"' class='doc-link' href='" + link.url + "'>" + link.text + "</a></div>");
    });
    while (linkOptions.length < 4) {
      linkOptions.push("<div></div>");
    }
    jQuery("#link").html(linkOptions.join(""));
  }

  function showStatusWarning(selectedSlug) {
    curVersion = _.find(releases[curSystem], { 'slug': selectedSlug });
    if (curVersion.status !== "stable") {
      jQuery("#notstable").fadeOut(150).removeClass();
      if (curVersion.status === "unstable") {
        jQuery("#notstable").text(curVersion.name +" is in active developemnt. Please be careful.").addClass("warn-"+curVersion.status).fadeIn(250);
      } else {
        jQuery("#notstable").text(curVersion.name +" is a "+ curVersion.status + " version released on " + curVersion.date + ".").addClass("warn-"+curVersion.status).fadeIn(250);
      }
    } else {
      jQuery("#notstable").slideUp(500);
    }
  }

  function populateBoxHeader() {
    jQuery("#current-version").text(curObject.name);
  }

  jQuery(document).ready(function() {
    jQuery("#float-box").css({"top": "%%TOP%%px", "right": "%%RIGHT%%px"});

    jQuery.ajax({
      url: "/documentation/releases.json",
      dataType: "json",
      success: function(data) {
        releases = {};
        _.forEach(data, function(system, systemKey) {
          releases[systemKey] = _.orderBy(system, "order", "desc");
        });
        curObject = _.find(releases[curSystem], { 'slug': curSlug });
        populateVersionSelect(releases[curSystem]);
        populateFormatFlex(curSlug);
        populateLinkFlex(curSlug);
        populateBoxHeader();
        showStatusWarning(curSlug);
        if (curObject.status !== "stable") {
          jQuery("#float-toggle").click();
        }
      }
    });

    jQuery("#version").selectric({
      optionsItemBuilder: function(itemData, element, index) {
        return itemData.text + "<span class='badge badge-" + jQuery(itemData.element).data("status") + "'>" + jQuery(itemData.element).data("status") + "</span>";
      }
    });

    jQuery("#version").change(function() {
      populateFormatFlex(jQuery(this).val());
      populateLinkFlex(jQuery(this).val());
      showStatusWarning(jQuery(this).val());
    });

    jQuery("#float-header").click(function() {
      jQuery(this).children("#float-toggle").toggleClass("float-close");
      jQuery(this).next().slideToggle();
    });

  });
  </script>
  <!-- googlize button end -->
EPILOG

our $prog = basename($0);

sub usage {
    print <<USAGE;
usage: $prog -h
       $prog [-t topcoord] [-r topcoord] [list of HTML files]

    -h  show summary of command line options and exit
    -t  top coordinate of Documentation Version Selector Box
    -r  right coordinate of Documentation Version Selector Box

$prog rewrites HTML files, inserting JS & CSS references and
Google Analytics code at </head> and a floating Documentation
Version Selector Box at </body>. $prog can be run multiple times
on an HTML file. If the added code is already present, it is
replaced, not added again.

A top and right coordinate for the Selector Box can be specified
with -t and -r respectively. This makes it possible to place
the Selector Box farther away from the borders of the page to
avoid overlaying navigation buttons. The default value for both is zero.

Basic Example:

    ./$prog -t25 -r25 processed/_build/html/*.html
USAGE
    exit ;
}

sub read_file {
    my $fname = shift;
    open my $fh, '<', $fname or die "cannot open '$fname':$!\n";
    my $content = do { local($/); <$fh> };
    close $fh or die "could not close file:$!\n";
    return $content;
}

sub write_file {
    my ($fname, $content) = @_;
    open my $fh, ">", $fname or die "could not write '$fname':$!\n";
    print $fh $content;
    close $fh or die "could not close '$fname':$!\n";
}

getopts('ht:r:');
usage() if $opt_h;

$opt_t = 0 unless defined($opt_t);
die '** -t argument (top coordinate) must be a number' unless (looks_like_number($opt_t));
$epilog =~ s/%%TOP%%/$opt_t/;

$opt_r = 0 unless defined($opt_r);
die '** -r argument (top coordinate) must be a number' unless (looks_like_number($opt_r));
$epilog =~ s/%%RIGHT%%/$opt_r/;

# main loop
foreach my $fname (@ARGV) {
    my $html = read_file($fname);

    print "$fname -";
    print " GA code ";
    if ( $html =~ /<!-- googlize start -->/ ) {
        print "replaced";
        $html =~ s%  <!-- googlize start -->.*<!-- googlize end -->\s+</head>%$prolog</head>%gs;
    } else {
        print "installed";
        $html =~ s%</head>%$prolog</head>%gs;
    }
    print ", button code ";
    if ( $html =~ /<!-- googlize button start -->/ ) {
        print "replaced";
        $html =~ s%  <!-- googlize button start -->.*<!-- googlize button end -->\s+</body>%$epilog</body>%gs;
    } else {
        print "installed";
        $html =~ s%</body>%$epilog</body>%gs;
    }
    print "\n";

    write_file($fname, $html);
}
